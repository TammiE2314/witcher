<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>泡泡信 · Bubble Letters</title>
  <link rel="stylesheet" href="./styles.css" />
  <meta name="color-scheme" content="light dark">
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">🫧</div>
      <div class="brandText">
        <div class="brandTitle">泡泡信</div>
        <div class="brandSub">分组 · 模板 · 导出 · 多设备同步（可选）</div>
      </div>
    </div>

    <div class="topActions">
      <button class="btn" id="btnSync">同步设置</button>
      <button class="btn" id="btnExport">导出</button>
      <button class="btn primary" id="btnNewEntry">新建泡泡</button>
    </div>
  </header>

  <main class="app">
    <aside class="panel left">
      <div class="panelHeader">
        <div class="panelTitle">泡泡组</div>
        <button class="btn tiny" id="btnNewGroup">＋新建组</button>
      </div>

      <div class="groupList" id="groupList"></div>

      <div class="panelFooter">
        <div class="hint">提示：不配置同步也能用（本机存储）。配置后可多设备共享。</div>
      </div>
    </aside>

    <section class="panel center">
      <div class="panelHeader">
        <div class="panelTitle" id="centerTitle">编辑</div>
        <div class="centerActions">
          <button class="btn tiny" id="btnEditSchema">编辑模板</button>
          <button class="btn tiny" id="btnSaveEntry">保存</button>
          <button class="btn tiny ghost" id="btnDeleteEntry">删除</button>
        </div>
      </div>

      <div class="editor" id="editor">
        <div class="emptyState" id="emptyEditor">
          <div class="emptyBig">先选一个泡泡组</div>
          <div class="emptySmall">然后点右上角「新建泡泡」开始写信。</div>
        </div>
      </div>
    </section>

    <aside class="panel right">
      <div class="panelHeader">
        <div class="panelTitle">泡泡</div>
        <div class="row">
          <select id="sortBy" class="select">
            <option value="auto">按：自动</option>
          </select>
          <button class="btn tiny" id="btnToggleSort">升序</button>
        </div>
      </div>

      <div class="bubbleList" id="bubbleList"></div>

      <div class="panelFooter">
        <div class="hint">泡泡只显示你选定的「大标题字段」。已导出的泡泡会变色。</div>
      </div>
    </aside>
  </main>

  <div class="backdrop" id="backdrop" hidden></div>

  <div class="modal" id="modalGroup" hidden>
    <div class="modalHeader">
      <div class="modalTitle">新建泡泡组</div>
      <button class="iconBtn" data-close="modalGroup">✕</button>
    </div>
    <div class="modalBody">
      <label class="field">
        <div class="label">组名</div>
        <input id="groupName" class="input" placeholder="比如：小初的信 / 旅行记录 / 备忘" />
      </label>
      <label class="field">
        <div class="label">默认模板</div>
        <div class="hint">创建后可在「编辑模板」里细调字段、顺序、显示标题。</div>
      </label>
      <div class="schemaPreset">
        <button class="chip" data-preset="letter">第x封信（标题/简介/内容）</button>
        <button class="chip" data-preset="memory">标题/时间/简介/内容</button>
        <button class="chip" data-preset="blank">空白模板</button>
      </div>
    </div>
    <div class="modalFooter">
      <button class="btn" data-close="modalGroup">取消</button>
      <button class="btn primary" id="btnCreateGroup">创建</button>
    </div>
  </div>

  <div class="modal wide" id="modalSchema" hidden>
    <div class="modalHeader">
      <div class="modalTitle">编辑模板</div>
      <button class="iconBtn" data-close="modalSchema">✕</button>
    </div>
    <div class="modalBody">
      <div class="grid2">
        <label class="field">
          <div class="label">泡泡组名</div>
          <input id="schemaGroupName" class="input" />
        </label>

        <label class="field">
          <div class="label">泡泡大标题字段</div>
          <select id="schemaTitleField" class="select"></select>
        </label>
      </div>

      <div class="sectionTitle">字段列表（可增删改）</div>
      <div class="table" id="schemaTable"></div>

      <div class="row gap">
        <button class="btn tiny" id="btnAddField">＋添加字段</button>
        <div class="hint">建议字段 key 用英文或拼音，比如 title / time / intro / content / zhengwen</div>
      </div>
    </div>
    <div class="modalFooter">
      <button class="btn" data-close="modalSchema">取消</button>
      <button class="btn primary" id="btnSaveSchema">保存模板</button>
    </div>
  </div>

  <div class="modal wide" id="modalExport" hidden>
    <div class="modalHeader">
      <div class="modalTitle">批量导出 JSON</div>
      <button class="iconBtn" data-close="modalExport">✕</button>
    </div>
    <div class="modalBody">
      <div class="grid2">
        <label class="field">
          <div class="label">导出范围</div>
          <select id="exportScope" class="select">
            <option value="selected">导出勾选的泡泡</option>
            <option value="all">导出全部泡泡</option>
          </select>
        </label>
        <label class="field">
          <div class="label">导出后标记</div>
          <select id="exportMark" class="select">
            <option value="mark">标记为已导出（变色）</option>
            <option value="keep">不标记</option>
          </select>
        </label>
      </div>

      <div class="sectionTitle">可视化 JSON 拼装（每条泡泡）</div>

      <label class="field">
        <div class="label">顶部一行（外壳开头）</div>
        <input id="exportTopLine" class="input" placeholder="xxxx：{" />
        <div class="hint">这一行只做外壳文本拼接，可写：data:{ 或 xxxx:{ 或 { "data": {</div>
      </label>

      <div class="jsonBuilder" id="jsonBuilder"></div>

      <label class="field">
        <div class="label">底部一行（外壳结尾）</div>
        <input id="exportBottomLine" class="input" placeholder="}," />
      </label>

      <label class="field">
        <div class="label">字段之间的分隔符（每行结尾）</div>
        <input id="exportLineComma" class="input" placeholder="" value="" />
        <div class="hint">留空时默认自动加逗号（最后一行不加）。你也可以写成 “，” 或 “,” 或 “,”+空格</div>
      </label>

      <label class="field">
        <div class="label">值的转义方式</div>
        <select id="exportEscapeMode" class="select">
          <option value="json">按 JSON 字符串转义（推荐）</option>
          <option value="raw">原样插入（不转义）</option>
        </select>
      </label>

      <div class="sectionTitle">生成结果</div>
      <label class="field">
        <textarea id="exportResult" class="textarea" rows="10" spellcheck="false"></textarea>
      </label>

      <div class="row gap">
        <button class="btn" id="btnCopyExport">复制</button>
        <button class="btn" id="btnDownloadExport">下载 .json</button>
        <div class="hint">这里输出的是你设定的文本外壳 + 泡泡真实内容。</div>
      </div>
    </div>
    <div class="modalFooter">
      <button class="btn" data-close="modalExport">关闭</button>
      <button class="btn primary" id="btnDoExport">生成</button>
    </div>
  </div>

  <div class="modal wide" id="modalSync" hidden>
    <div class="modalHeader">
      <div class="modalTitle">多设备同步设置（可选）</div>
      <button class="iconBtn" data-close="modalSync">✕</button>
    </div>
    <div class="modalBody">
      <div class="hint">
        默认用本机存储。想让手机和电脑共享数据，需要云端。
        这里集成 Supabase：建项目后粘贴 URL 和 anon key 就能同步。
      </div>

      <div class="grid2">
        <label class="field">
          <div class="label">Supabase Project URL</div>
          <input id="sbUrl" class="input" placeholder="https://xxxx.supabase.co" />
        </label>
        <label class="field">
          <div class="label">Supabase anon key</div>
          <input id="sbAnon" class="input" placeholder="eyJhbGciOi..." />
        </label>
      </div>

      <div class="grid2">
        <label class="field">
          <div class="label">工作区 ID（两端一致）</div>
          <input id="workspaceId" class="input" placeholder="例如：xiaoyuan" />
        </label>
        <label class="field">
          <div class="label">工作区口令（可选）</div>
          <input id="workspaceSecret" class="input" placeholder="写一个只有你知道的短口令" />
          <div class="hint">口令仅做简单区分，强安全需要升级版（登录 + 严格 RLS）。</div>
        </label>
      </div>

      <details class="details">
        <summary>展开：建表 SQL（复制到 Supabase SQL Editor 执行）</summary>
        <pre class="code" id="schemaSql"></pre>
      </details>

      <div class="row gap">
        <button class="btn" id="btnTestSync">测试连接</button>
        <button class="btn" id="btnPushLocal">上传本机数据到云端</button>
        <button class="btn" id="btnPullCloud">从云端拉取到本机</button>
      </div>
      <div class="hint" id="syncStatus"></div>
    </div>
    <div class="modalFooter">
      <button class="btn" data-close="modalSync">关闭</button>
      <button class="btn primary" id="btnSaveSync">保存设置</button>
    </div>
  
  <div class="modal" id="modalEntry" hidden>
    <div class="modalHeader">
      <div class="modalTitle" id="entryModalTitle">新建泡泡</div>
      <button class="iconBtn" data-close="modalEntry">✕</button>
    </div>
    <div class="modalBody">
      <div class="hint" id="entryModalHint">按当前泡泡组模板填写内容。</div>
      <div id="entryForm"></div>
    </div>
    <div class="modalFooter">
      <button class="btn" data-close="modalEntry">取消</button>
      <button class="btn primary" id="btnEntrySave">保存</button>
    </div>
  </div>


</div>

  <script src="./sync-supabase.js"></script>
  <script src="./app.js"></script>
</body>
</html>
